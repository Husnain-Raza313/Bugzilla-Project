
<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>
function changeStatusforBug(){
  var element = document.getElementById("feature_status");
  element.classList.add("status_class");
  var element = document.getElementById("bug_status");
  element.classList.remove("status_class");

}

 function changeStatusforFeature(){
  var element = document.getElementById("bug_status");
  element.classList.add("status_class");
  var element = document.getElementById("feature_status");
  element.classList.remove("status_class");





 }

function checkStatus(){
  link = document.querySelector('#feature_id');
    let check = link.getAttribute('checked');
  console.log(check)
  check== null ? changeStatusforBug() : changeStatusforFeature()

}

function loadBugs() {
   var bugs=[];
      let STATUS = $('#status').val();
    $.ajax({
      type: "GET",
      contentType: "application/json; charset=utf-8",
      url: "/bugs/autocomplete?status="+STATUS+"&&autocomplete=true",
      dataType: "json",
      success: function (data) {
         console.log(data);
         bugs=data;
         <%# result($.map(data,function(item){
          return item;
         })); %>
      },

      error : function(data) {

      }
   });

<%# $('#bugs_search').typeahead({minLength: 1,
    order: "asc",
    source: function(query, result){

      let STATUS = $('#status').val();
      let QUERY = $('#bugs_search').val();

      $.ajax({
      type: "GET",
      contentType: "application/json; charset=utf-8",
      url: "/bugs/autocomplete?query="+QUERY+"&&status="+STATUS,
      dataType: "json",
      success: function (data) {
         console.log(data);
         bugs=data;
         result($.map(data,function(item){
          return item;
         }));
      },

      error : function(data) {

      }
   });


}}); %>

var inputBox = document.querySelector(".typeahead");
var searchWrapper = document.querySelector(".search-input");
var suggBox = searchWrapper.querySelector(".autocom-box");
inputBox.onkeyup = (e)=>{
    let userData = e.target.value;
    let emptyArray = [];
    if(userData){
      emptyArray = bugs.filter((data)=>{
            return data.toLocaleLowerCase().startsWith(userData.toLocaleLowerCase());
        });
        emptyArray = emptyArray.map((data)=>{
            return data = `<li>${data}</li>`;
        });
        searchWrapper.classList.add("active");
        showSuggestions(emptyArray);
        let allList = suggBox.querySelectorAll("li");
        for (let i = 0; i < allList.length; i++) {
            allList[i].addEventListener ("click", function() { select(allList[i]) });
        }
    }else{
        searchWrapper.classList.remove("active");
    }
}
function select(element){
    let selectData = element.textContent;
    inputBox.value = selectData;
    console.log(element);
    searchWrapper.classList.remove("active");
}
function showSuggestions(list){
    let listData;
    if(!list.length){
        userValue = inputBox.value;
        listData = `<li>${userValue}</li>`;
    }else{
      listData = list.join('');
    }
    suggBox.innerHTML = listData;
}

};


$(document).on('click', '#submission-btn', function(){
  $(".modal-success-message").remove();
  $(".modal-error-message").remove();
  var stripe = Stripe('<%= Rails.application.credentials[:stripe][:public] %>');
    var fonts = [{
    cssSrc: "https://fonts.googleapis.com/css?family=Karla",
  }];
  // styles for the stripe inputs
  var styles = {
    base: {
      iconColor: "#cccccc",
      color: "#000000",
      fontFamily: "MonumentGroteskTrial-Regular",
      fontSize: "16px",

      "::placeholder": {
        color: "#ccc"
      },
      ":-webkit-autofill": {
        color: "#ccc"
      }
    },
    invalid: {
      iconColor: "#FFC7EE",
      color: "#A31621"
    }
  }

  var elements = stripe.elements();
  var cardElement = elements.create('card', {style: styles});
  cardElement.mount('#card');

    const form = document.querySelector('#new_submission');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    $('#loadingBar').addClass('loader');
    let bugID = $('#bugID').html();
    // Step 1: POST request to create payment intent
    fetch('/payment_intents?id='+bugID, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then((response) => response.json())
    .then((paymentIntent) => {
      // Step 2: Create payment method and confirm payment intent.
      if (paymentIntent.message){
       errorMsgFn(paymentIntent.message);
       }
      stripe.confirmCardPayment(
        paymentIntent.client_secret, {
          payment_method: {
            card: cardElement
          }
        }
      ).then((resp) => {
        $('#loadingBar').removeClass('loader');
        if(resp.error) {
          errorMsgFn(resp.error.message);
        } else {
          setTimeout(function () {
              $('#close-btn').trigger('click');
              $(".modal-success-message").remove();
              $(".modal-success-error").remove();
            }, 1000);

          successMsgFn(resp.paymentIntent.status);
          form.clear();
        }
      })
    })
    .catch((error) => {
      console.log(error.message);
    });
  });

});

successMsgFn = (msg) =>{
          $(".modal-error-message").remove();
          $(".modal-body").prepend("<div class='modal-success-message bg-success text-white text-center '></div>");
          $('.modal-success-message').html(msg);
}

errorMsgFn = (msg) =>{
          $(".modal-success-message").remove();
          $(".modal-body").prepend("<div class='modal-error-message bg-danger text-white text-center '></div>");
          $('.modal-error-message').html(msg);
}



